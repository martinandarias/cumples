<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Cumplea√±os del mes</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* =====================================================
   PALETA
===================================================== */
:root {
    --bg-main: #7c2cff;
    --card-bg: rgba(255,255,255,0.16);
    --card-border: rgba(255,255,255,0.28);
    --card-subtle: rgba(255,255,255,0.88);
    --primary: #7c2cff;
    --text-main: #111827;
    --text-soft: #6b7280;
    --radius-lg: 24px;
}

/* =====================================================
   BASE
===================================================== */
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
    display: flex;
    justify-content: center;
    background: radial-gradient(circle at top, #a855ff 0%, #4c1d95 35%, #1f102f 100%);
    font-family: 'Inter', sans-serif;
    font-weight: 400;
    letter-spacing: 0.2px;
    color: #f9fafb;
    margin: 0;
    min-height: 100vh;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    text-rendering: optimizeLegibility;
}

.app {
    width: 100%;
    max-width: 480px;
    padding: 24px 16px 40px;
}

/* T√≠tulos en el fondo violeta */
#mainView h1 {
    font-size: 26px;
    font-weight: 600;
    color: #f9fafb;
    margin-bottom: 4px;
}

#mainView p {
    font-size: 14px;
    color: #e5e7eb;
}

/* Texto dentro de cards */
.card h2,
.card p,
.nombre,
.detalle {
    color: var(--text-main);
}

/* Animaciones base */
.fade-in {
    animation: fadeIn 0.35s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
}

/* Transici√≥n de lista al cambiar mes */
.list {
    transition: opacity 0.25s ease, transform 0.25s ease;
}

.list.fade-out {
    opacity: 0;
    transform: translateY(6px);
}

/* =====================================================
   BOTONES DE NAVEGACI√ìN
===================================================== */
.nav-btns {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
    gap: 8px;
}

.nav-btns button {
    flex: 1;
    border: none;
    background: radial-gradient(circle at top left, #8b5cf6, #4c1d95);
    color: white;
    padding: 8px 14px;
    border-radius: 999px;
    font-size: 13px;
    cursor: pointer;
    transition: transform 0.16s ease, box-shadow 0.16s ease, opacity 0.16s ease;
    box-shadow: 0 10px 22px rgba(15, 23, 42, 0.35);
}

.nav-btns button:hover {
    transform: translateY(-1px) scale(1.02);
    box-shadow: 0 14px 28px rgba(15, 23, 42, 0.45);
    opacity: 0.95;
}

.nav-btns button:active {
    transform: translateY(1px) scale(0.98);
    box-shadow: 0 6px 14px rgba(15, 23, 42, 0.4);
}

/* =====================================================
   FAB "VOLVER AL MES ACTUAL"
===================================================== */
#btnHoy {
    position: fixed;
    right: 18px;
    bottom: 20px;
    width: 52px;
    height: 52px;
    border-radius: 999px;
    border: none;
    background: radial-gradient(circle at top left, #a855f7, #4338ca);
    color: #f9fafb;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 16px 40px rgba(15, 23, 42, 0.6);
    display: none;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 6px;
    line-height: 1.1;
    z-index: 1500;
    transition: transform 0.18s ease, opacity 0.18s ease, box-shadow 0.18s ease;
}

#btnHoy.show {
    display: flex;
    opacity: 1;
    transform: translateY(0);
}

#btnHoy:hover {
    transform: translateY(-2px) scale(1.03);
    box-shadow: 0 18px 44px rgba(15, 23, 42, 0.7);
}

#btnHoy:active {
    transform: translateY(1px) scale(0.97);
}

/* =====================================================
   CARDS (GLASSMORPHISM)
===================================================== */
.card {
    background: var(--card-bg);
    border-radius: 32px;
    padding: 18px 16px 16px;
    box-shadow: 0 18px 48px rgba(15, 23, 42, 0.55);
    border: 1px solid var(--card-border);
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
}

.header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.header-row h2 {
    font-size: 18px;
    font-weight: 600;
}

.badge-month {
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 999px;
    background: linear-gradient(135deg, #f97316, #fb7185);
    color: white;
    font-weight: 500;
}

/* =====================================================
   LISTA Y PERSONAS
===================================================== */
.list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-height: 60vh;
    overflow-y: auto;
    padding-right: 2px;
}

.person {
    background: var(--card-subtle);
    border-radius: 18px;
    padding: 10px 11px;
    display: flex;
    gap: 10px;
    align-items: center;
    cursor: pointer;
    transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    color: var(--text-main);
}

.person:hover {
    background: #f3e8ff;
    box-shadow: 0 10px 24px rgba(124, 58, 237, 0.45);
    transform: translateY(-2px);
}

.person:active {
    transform: translateY(1px) scale(0.99);
    box-shadow: 0 5px 14px rgba(124, 58, 237, 0.5);
}

.avatar {
    width: 38px;
    height: 38px;
    border-radius: 16px;
    background: linear-gradient(135deg, #a855f7, #ec4899);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 18px;
    font-weight: 700;
    flex-shrink: 0;
}

.info { flex: 1; min-width: 0; }

.nombre {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 2px;
}

.detalle {
    font-size: 12px;
    color: var(--text-soft);
}

/* =====================================================
   ALIAS / SUBIR CONSTANCIA
===================================================== */
.alias-btn,
.btn-upload {
    background: linear-gradient(135deg, #7c3aed, #4f46e5);
    border-radius: 999px;
    color: white;
    padding: 6px 12px;
    cursor: pointer;
    border: none;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.25px;
    box-shadow: 0 10px 24px rgba(37, 99, 235, 0.5);
    transition: transform 0.16s ease, box-shadow 0.16s ease, opacity 0.16s ease;
}

.alias-btn {
    padding: 6px 14px;
    animation: aliasPulse 2s infinite alternate;
}

.alias-btn:hover,
.btn-upload:hover {
    transform: translateY(-1px) scale(1.03);
    box-shadow: 0 14px 30px rgba(37, 99, 235, 0.65);
    opacity: 0.96;
}

.alias-btn:active,
.btn-upload:active {
    transform: translateY(1px) scale(0.97);
    box-shadow: 0 8px 18px rgba(37, 99, 235, 0.6);
}

@keyframes aliasPulse {
    0% { transform: scale(1); }
    100% { transform: scale(1.05); }
}

.status {
    font-size: 11px;
    margin-top: 4px;
}

/* Inputs ocultos */
input[type="file"] { display: none; }

/* =====================================================
   LOADING OVERLAY GLOBAL
===================================================== */
#loadingOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at top, rgba(88,28,135,0.5), rgba(17,24,39,0.9));
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.loader {
    border: 6px solid #d1c4ff;
    border-top: 6px solid #7c3aed;
    border-radius: 50%;
    width: 55px;
    height: 55px;
    animation: spin .8s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* =====================================================
   LOADING DETALLE (spinner)
===================================================== */
#detalleLoading {
    width: 100%;
    padding: 20px 0;
    display: none;
    justify-content: center;
}

.detalle-spinner {
    border: 5px solid #ddd2ff;
    border-top: 5px solid #7c3aed;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    animation: spin .8s linear infinite;
}

/* =====================================================
   SKELETON LOADERS
===================================================== */
.skeleton {
    background: linear-gradient(90deg, #e6dbff 0%, #f2ecff 50%, #e6dbff 100%);
    background-size: 200% 100%;
    animation: skeletonAnim 1.2s infinite;
    border-radius: 16px;
}

@keyframes skeletonAnim {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

.skel-item {
    height: 60px;
}

/* Responsive */
@media (max-width: 480px) {
    .card { border-radius: 26px; }
}
</style>
</head>

<body>

<!-- OVERLAY LOADING GLOBAL -->
<div id="loadingOverlay">
    <div class="loader"></div>
</div>

<!-- FAB VOLVER AL MES ACTUAL -->
<button id="btnHoy">Mes<br>actual</button>

<!-- ============================
     VISTA PRINCIPAL
============================ -->
<div class="app fade-in" id="mainView">
    <h1>Cumples del mes üéâ</h1>
    <p>Sub√≠ la constancia de pago para cada cumplea√±ero</p>

    <div class="nav-btns">
        <button id="btnPrev">‚Üê Mes anterior</button>
        <button id="btnNext">Mes siguiente ‚Üí</button>
    </div>

    <div class="card fade-in">
        <div class="header-row">
            <h2></h2>
            <div class="badge-month" id="badgeMes"></div>
        </div>

        <div id="lista" class="list"></div>
    </div>
</div>

<!-- ============================
     VISTA DETALLE
============================ -->
<div class="app fade-in" id="detalle" style="display:none;">
    <button id="volver"
        style="background:none;border:none;color:white;font-size:16px;margin-bottom:10px;cursor:pointer;">
        ‚Üê Volver
    </button>

    <div class="card fade-in">
        <h2 id="detalleTitulo"></h2>
        <p id="detalleFecha" style="color:#000;font-size:14px;margin-bottom:10px;"></p>


        <div id="detalleLoading">
            <div class="detalle-spinner"></div>
        </div>

        <div id="listaCurso" class="list"></div>
    </div>
</div>

<!-- =====================================================
     SCRIPT
===================================================== -->
<script>
function showLoading() {
    document.getElementById("loadingOverlay").style.display = "flex";
}
function hideLoading() {
    document.getElementById("loadingOverlay").style.display = "none";
}

const WEB_APP_URL =
 "https://script.google.com/macros/s/AKfycbwEzWClX4Q_XLEFPLtjGBhkhJZK3vCq1fLg6lzY-tRBrh_pJaZINy5xSKBXp0R3QOkDhQ/exec";

const meses = [
    "Enero","Febrero","Marzo","Abril","Mayo","Junio",
    "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"
];

let hoy   = new Date();
let hoyMes  = hoy.getMonth() + 1;
let hoyAnio = hoy.getFullYear();

let mesActualEnPantalla  = hoyMes;
let anioActualEnPantalla = hoyAnio;

/* =====================================================
   FAB VISIBILIDAD
===================================================== */
function updateFabHoy() {
    const fab = document.getElementById("btnHoy");
    if (mesActualEnPantalla === hoyMes && anioActualEnPantalla === hoyAnio) {
        fab.classList.remove("show");
        fab.style.display = "none";
    } else {
        fab.style.display = "flex";
        // timeout corto para que la transici√≥n se vea
        setTimeout(() => fab.classList.add("show"), 10);
    }
}

document.getElementById("btnHoy").onclick = () => {
    mesActualEnPantalla  = hoyMes;
    anioActualEnPantalla = hoyAnio;
    cargarCumples();
};

/* =====================================================
   NAVEGACI√ìN MESES
===================================================== */
document.getElementById("btnPrev").onclick = () => {
    mesActualEnPantalla--;
    if (mesActualEnPantalla === 0) {
        mesActualEnPantalla = 12;
        anioActualEnPantalla--;
    }
    cargarCumples();
};

document.getElementById("btnNext").onclick = () => {
    mesActualEnPantalla++;
    if (mesActualEnPantalla === 13) {
        mesActualEnPantalla = 1;
        anioActualEnPantalla++;
    }
    cargarCumples();
};

/* =====================================================
   SKELETON (lista principal)
===================================================== */
function renderSkeletonLista() {
    const cont = document.getElementById("lista");
    cont.innerHTML = "";
    for (let i = 0; i < 6; i++) {
        const sk = document.createElement("div");
        sk.className = "skeleton skel-item";
        cont.appendChild(sk);
    }
}

/* =====================================================
   CARGAR CUMPLES
===================================================== */
function cargarCumples() {
    showLoading();
    updateFabHoy();

    const lista = document.getElementById("lista");
    lista.classList.add("fade-out");
    renderSkeletonLista();

    document.getElementById("badgeMes").textContent =
        meses[mesActualEnPantalla - 1] + " " + anioActualEnPantalla;

    fetch(`${WEB_APP_URL}?action=list&mes=${mesActualEnPantalla}&anio=${anioActualEnPantalla}`)
        .then(r => r.json())
        .then(data => {
            renderLista(data);
            lista.classList.remove("fade-out");
            hideLoading();
        })
        .catch(() => {
            lista.classList.remove("fade-out");
            hideLoading();
        });
}

/* =====================================================
   LISTA PRINCIPAL
===================================================== */
function renderLista(personas) {
    const cont = document.getElementById("lista");
    cont.innerHTML = "";

    if (!personas || personas.length === 0) {
        cont.innerHTML = "<p class='detalle'>No hay cumplea√±os para este mes.</p>";
        return;
    }

    personas.forEach(p => {
        const card = document.createElement("div");
        card.className = "person fade-in";
        card.onclick = () => abrirDetalle(p);

        const avatar = document.createElement("div");
        avatar.className = "avatar";
        avatar.textContent = p.nombre.charAt(0).toUpperCase();

        const info = document.createElement("div");
        info.className = "info";
        info.innerHTML = `
            <div class="nombre">${p.nombre}</div>
            <div class="detalle">üéÇ ${p.fecha_cumple}</div>
        `;

        card.appendChild(avatar);
        card.appendChild(info);
        cont.appendChild(card);
    });
}

/* =====================================================
   DETALLE
===================================================== */
function abrirDetalle(cumple) {
    window.aliasActual = cumple.alias;
    window.cumpleNombreCompleto = cumple.nombre;

    document.getElementById("mainView").style.display = "none";
    document.getElementById("detalle").style.display = "block";

    document.getElementById("detalleTitulo").textContent = cumple.nombre;

    document.getElementById("detalleFecha").innerHTML = `
        üéÇ ${cumple.fecha_cumple} ‚Ä¢ 
        <button id="aliasCopy" class="alias-btn">Copiar alias</button>
    `;

    document.getElementById("listaCurso").style.display = "none";
    document.getElementById("detalleLoading").style.display = "flex";

    fetch(`${WEB_APP_URL}?action=curso&id_cumple=${cumple.id_cumple}`)
        .then(r => r.json())
        .then(data => {
            renderCurso(data, cumple);
            document.getElementById("detalleLoading").style.display = "none";
            document.getElementById("listaCurso").style.display = "flex";
        });
}

document.getElementById("volver").onclick = () => {
    document.getElementById("mainView").style.display = "block";
    document.getElementById("detalle").style.display = "none";
};

/* =====================================================
   CURSO + HISTORIAL
===================================================== */
function renderCurso(data, cumple) {
    const listado   = data.curso;
    const historial = data.historial;

    const cont = document.getElementById("listaCurso");
    cont.innerHTML = "";

    listado.forEach((alumno, index) => {

        const yaPago = historial.some(h =>
            h.id_cumple == cumple.id_cumple &&
            h.id_curso == alumno.id_curso
        );

        const row = document.createElement("div");
        row.className = "person fade-in";

        const avatar = document.createElement("div");
        avatar.className = "avatar";
        avatar.textContent = alumno.nombre.charAt(0).toUpperCase();

        const info = document.createElement("div");
        info.className = "info";
        info.innerHTML = `
            <div class="nombre">${alumno.nombre} ${alumno.apellido}</div>
            <div class="detalle">${alumno.estado}</div>
        `;

        const upload = document.createElement("div");
        upload.style.display = "flex";
        upload.style.flexDirection = "column";
        upload.style.alignItems = "flex-end";

        const status = document.createElement("div");
        status.className = "status";

        if (yaPago) {
            status.textContent = "Transferencia realizada ‚úì";
            status.style.color = "#16a34a";
            status.style.fontWeight = "bold";
            upload.appendChild(status);
        } else {
            const inp = document.createElement("input");
            inp.type  = "file";
            inp.accept = "image/*";
            inp.id = "file_" + index;

            const btn = document.createElement("button");
            btn.className = "btn-upload";
            btn.textContent = "Subir constancia";
            btn.onclick = e => { e.stopPropagation(); inp.click(); };

            inp.addEventListener("change", e => {
                if (!e.target.files.length) return;

                const file = e.target.files[0];
                const ext  = file.name.split(".").pop();

                const year  = anioActualEnPantalla;
                const month = mesActualEnPantalla;

                const alumnoBase = `${alumno.nombre}_${alumno.apellido}`.replace(/[^a-zA-Z0-9]/g, "_");
                const cumpleBase = cumple.nombre.replace(/[^a-zA-Z0-9]/g, "_");

                const fileName = `${cumpleBase}__${alumnoBase}_${month}_${year}_constancia_pago.${ext}`;

                status.textContent = "Subiendo...";
                status.style.color = "#f97316";

                subirArchivoCurso(file, fileName, month, year, status, cumple.id_cumple, alumno.id_curso);
            });

            upload.appendChild(btn);
            upload.appendChild(status);
            row.appendChild(inp);
        }

        row.appendChild(avatar);
        row.appendChild(info);
        row.appendChild(upload);

        cont.appendChild(row);
    });
}

/* =====================================================
   SUBIDA CONSTANCIA
===================================================== */
function subirArchivoCurso(file, fileName, month, year, statusEl, id_cumple, id_curso) {
    const reader = new FileReader();
    reader.onload = e => {
        const base64 = e.target.result.split(",")[1];

        fetch(WEB_APP_URL, {
            method: "POST",
            body: JSON.stringify({
                fileName,
                mimeType: file.type,
                base64,
                month,
                year,
                id_cumple,
                id_curso
            })
        })
        .then(r => r.json())
        .then(resp => {
            if (resp.success) {
                statusEl.textContent = "Transferencia realizada ‚úì";
                statusEl.style.color = "#16a34a";
                statusEl.style.fontWeight = "bold";
            } else {
                statusEl.textContent = "Error al subir";
                statusEl.style.color = "#dc2626";
            }
        })
        .catch(() => {
            statusEl.textContent = "Error de red";
            statusEl.style.color = "#dc2626";
        });
    };

    reader.readAsDataURL(file);
}

/* =====================================================
   COPIAR ALIAS
===================================================== */
document.addEventListener("click", e => {
    if (e.target.id === "aliasCopy") {
        navigator.clipboard.writeText(window.aliasActual)
            .then(() => {
                e.target.textContent = "Alias copiado ‚úì";
                setTimeout(() => e.target.textContent = "Copiar alias", 1500);
            });
    }
});

/* =====================================================
   INICIO
===================================================== */
cargarCumples();
</script>

</body>
</html>
