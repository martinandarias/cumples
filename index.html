<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Cumplea√±os del mes</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
    :root {
        --bg-main: #7c2cff;
        --card-bg: #ffffff;
        --card-subtle: #f5f0ff;
        --primary: #7c2cff;
        --text-main: #1f1235;
        --text-soft: #6b6b7b;
        --radius-lg: 24px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #a855ff, #4c1d95);
        color: white;
        min-height: 100vh;
        display: flex;
        justify-content: center;
    }

    .app {
        width: 100%;
        max-width: 480px;
        padding: 24px 16px 40px;
    }

    .title {
        text-align: center;
        margin-bottom: 16px;
    }
    .title h1 {
        font-size: 26px;
        font-weight: 700;
        margin-bottom: 4px;
    }
    .title p {
        font-size: 14px;
        color: #f3e8ff;
    }

    .card {
        background: var(--card-bg);
        border-radius: 32px;
        padding: 18px 16px 16px;
        box-shadow: 0 12px 30px rgba(21, 10, 40, 0.45);
    }

    .header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .header-row h2 {
        font-size: 18px;
        color: var(--text-main);
    }

    .badge-month {
        font-size: 12px;
        padding: 4px 10px;
        border-radius: 999px;
        background: linear-gradient(135deg, #f97316, #fb7185);
        color: white;
    }

    .list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 60vh;
        overflow-y: auto;
        padding-right: 4px;
    }

    .person {
        background: var(--card-subtle);
        border-radius: 18px;
        padding: 10px 10px;
        display: flex;
        gap: 8px;
        align-items: center;
    }
.person {
    background: var(--card-subtle);
    border-radius: 18px;
    padding: 10px 10px;
    display: flex;
    gap: 8px;
    align-items: center;
    transition: all 0.2s ease-in-out;
    cursor: pointer; /* cursor manito */
}

/* Efecto hover */
.person:hover {
    background: #eee6ff; /* un violeta muy suave */
    box-shadow: 0 4px 12px rgba(124, 44, 255, 0.4);
    transform: translateY(-2px);
}


#aliasCopy:hover {
    text-decoration: underline;
    opacity: 0.8;
}

    .avatar {
        width: 38px;
        height: 38px;
        border-radius: 16px;
        background: linear-gradient(135deg, #a855f7, #ec4899);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 18px;
        flex-shrink: 0;
    }

    .info {
        flex: 1;
        min-width: 0;
    }

    .nombre {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-main);
        margin-bottom: 2px;
    }

    .detalle {
        font-size: 12px;
        color: var(--text-soft);
    }

    .detalle span {
        display: inline-block;
        margin-right: 8px;
    }

    .upload-area {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
    }

    .btn-upload {
        border: none;
        border-radius: 999px;
        padding: 6px 12px;
        background: linear-gradient(135deg, #7c3aed, #4f46e5);
        color: white;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        white-space: nowrap;
    }

.alias-btn {
    background: linear-gradient(135deg, #7c3aed, #4f46e5);
    color: white;
    padding: 6px 14px;
    font-size: 12px;
    font-weight: 600;
    border: none;
    border-radius: 999px;
    cursor: pointer;
    animation: aliasPulse 2s infinite alternate;
    transition: all 0.3s ease-in-out;
}

/* Animaci√≥n suave de color ‚Äúrespirando‚Äù */
@keyframes aliasPulse {
    0% {
        background: linear-gradient(135deg, #7c3aed, #4f46e5);
        transform: scale(1);
    }
    100% {
        background: linear-gradient(135deg, #a855f7, #7c3aed);
        transform: scale(1.05);
    }
}

.alias-btn:hover {
    opacity: 0.9;
    transform: scale(1.07);
}


    .status {
        font-size: 10px;
        color: #16a34a;
    }

    input[type="file"] {
        display: none;
    }

    @media (max-width: 480px) {
        .card {
            border-radius: 24px;
        }
    }
</style>
</head>
<body>
<div class="app">
    <div class="app" id="mainView">


        <h1>Cumples del mes üéâ</h1>
        <p>Sub√≠ la constancia de pago para cada cumplea√±ero</p>
    </div>

    <div class="card">
        <div class="header-row">
            <h2>Listado</h2>
            <div class="badge-month" id="badgeMes"></div>
        </div>
        <div id="lista" class="list">
            <!-- ac√° se inyectan las filas -->
        </div>
    </div>
</div>

<div class="app" id="detalle" style="display:none;">
    <button id="volver" style="
        background:none;border:none;color:white;font-size:16px;margin-bottom:10px;cursor:pointer;">
        ‚Üê Volver
    </button>

    <div class="card">
        <h2 id="detalleTitulo"></h2>
        <p id="detalleFecha" style="color:#6b6b7b;font-size:14px;margin-bottom:10px;"></p>

        <div id="listaCurso" class="list"></div>
    </div>
</div>





<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyZQIfMET2DlOP6pJakkbo5feNUckhemURbG3-oE8qQpbd9Jl82U2RjYtcVtMN4UaWhdQ/exec"; // la que te dio Apps Script

// Helper: nombre del mes actual
const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
const hoy = new Date();
document.getElementById('badgeMes').textContent = meses[hoy.getMonth()] + " " + hoy.getFullYear();

// Traer cumplea√±eros
fetch(WEB_APP_URL + "?action=list")
  .then(r => r.json())
  .then(data => renderLista(data))
  .catch(err => {
      console.error(err);
      document.getElementById('lista').innerHTML = "<p>Error al cargar los cumplea√±os.</p>";
  });

function renderLista(personas) {
    const cont = document.getElementById("lista");
    cont.innerHTML = "";

    if (!personas || personas.length === 0) {
        cont.innerHTML = "<p style='color:#6b6b7b;font-size:13px;'>No hay cumplea√±os este mes.</p>";
        return;
    }

    personas.forEach((p, index) => {

        const card = document.createElement("div");
        card.className = "person";

        // Navegar al detalle
        card.onclick = () => abrirDetalle(p);

        const avatar = document.createElement("div");
        avatar.className = "avatar";
        avatar.textContent = p.nombre ? p.nombre.charAt(0).toUpperCase() : "?";

        const info = document.createElement("div");
        info.className = "info";
        info.innerHTML = `
            <div class="nombre">${p.nombre}</div>
            <div class="detalle">
                <span>üéÇ ${p.fecha_cumple}</span>
                
            </div>
        `;

        card.appendChild(avatar);
        card.appendChild(info);

        cont.appendChild(card);
    });
}


// Subir archivo a Apps Script / Drive
function subirArchivo(file, persona, statusEl) {
    statusEl.style.color = "#f97316";
    statusEl.textContent = "Subiendo...";

    const reader = new FileReader();
    reader.onload = function(e) {
        const base64 = e.target.result.split(",")[1];

        const now = new Date();
        const month = persona.mes;
const year = new Date().getFullYear();

        const ext = file.name.split(".").pop();
        const nombreLimpio = persona.nombre.replace(/[^a-zA-Z0-9_]/g, "_");

        const fileName = `${nombreLimpio}_${String(month).padStart(2,'0')}_${year}_constancia_pago.${ext}`;

fetch(WEB_APP_URL, {
    method: "POST",
    body: JSON.stringify({
        fileName,
        mimeType: file.type,
        base64,
        month,
        year
    })
})
        .then(r => r.json())
        .then(resp => {
            if (resp.success) {
                statusEl.style.color = "#16a34a";
                statusEl.textContent = "Subido ‚úÖ";
            } else {
                statusEl.style.color = "#dc2626";
                statusEl.textContent = "Error al subir";
                console.error(resp);
            }
        })
        .catch(err => {
            statusEl.style.color = "#dc2626";
            statusEl.textContent = "Error de red";
            console.error(err);
        });
    };
    reader.readAsDataURL(file);
}

function abrirDetalle(cumple) {
    window.aliasActual = cumple.alias;
    window.cumpleNombreCompleto = cumple.nombre;

    document.getElementById("mainView").style.display = "none";
    document.getElementById("detalle").style.display = "block";

    document.getElementById("detalleTitulo").textContent = cumple.nombre;

    document.getElementById("detalleFecha").innerHTML = `
        üéÇ ${cumple.fecha_cumple}
        ‚Ä¢
        <button id="aliasCopy" class="alias-btn">Copiar alias</button>
    `;

    fetch(WEB_APP_URL + "?action=curso")
        .then(r => r.json())
        .then(data => renderCurso(data, cumple))
        .catch(err => console.error(err));
}



function renderCurso(listado, cumple) {
    const cont = document.getElementById("listaCurso");
    cont.innerHTML = "";

    listado.forEach((alumno, index) => {
        const row = document.createElement("div");
        row.className = "person";

        const avatar = document.createElement("div");
        avatar.className = "avatar";
        avatar.textContent = alumno.nombre.charAt(0).toUpperCase();

        const info = document.createElement("div");
        info.className = "info";
        info.innerHTML = `
            <div class="nombre">${alumno.nombre} ${alumno.apellido}</div>
            <div class="detalle">
                <span>${alumno.estado}</span>
            </div>
        `;

        const uploadArea = document.createElement("div");
        uploadArea.className = "upload-area";

        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.accept = "image/*";
        fileInput.id = "curso_file_" + index;

        const btn = document.createElement("button");
        btn.className = "btn-upload";
        btn.textContent = "Subir constancia";
        btn.onclick = (event) => {
            event.stopPropagation();
            fileInput.click();
        };

        const status = document.createElement("div");
        status.className = "status";

        fileInput.addEventListener("change", (e) => {
    if (e.target.files.length === 0) return;
    const file = e.target.files[0];

    // Mes y a√±o del cumple seleccionado
    const month = cumple.mes;
    const year = new Date().getFullYear();

    const ext = file.name.split(".").pop();

    // Alumno
    const alumnoBase = `${alumno.nombre}_${alumno.apellido}`.replace(/[^a-zA-Z0-9]/g, "_");

    // Cumplea√±ero
    const cumpleBase = window.cumpleNombreCompleto.replace(/[^a-zA-Z0-9]/g, "_");

    // Nombre final NUEVO
    const fileName = `${cumpleBase}__${alumnoBase}_${month}_${year}_constancia_pago.${ext}`;

    subirArchivoCurso(file, fileName, month, year, status);
});


        uploadArea.appendChild(btn);
        uploadArea.appendChild(status);

        row.appendChild(avatar);
        row.appendChild(info);
        row.appendChild(uploadArea);
        row.appendChild(fileInput);

        cont.appendChild(row);
    });
}
function subirArchivoCurso(file, fileName, month, year, statusEl) {
    statusEl.style.color = "#f97316";
    statusEl.textContent = "Subiendo...";

    const reader = new FileReader();
    reader.onload = function(e) {
        const base64 = e.target.result.split(",")[1];

        fetch(WEB_APP_URL, {
            method: "POST",
            body: JSON.stringify({
                fileName,
                mimeType: file.type,
                base64,
                month,
                year
            })
        })
        .then(r => r.json())
        .then(resp => {
            if (resp.success) {
                statusEl.style.color = "#16a34a";
                statusEl.textContent = "Subido ‚úì";
            } else {
                statusEl.style.color = "#dc2626";
                statusEl.textContent = "Error";
            }
        })
        .catch(err => {
            statusEl.style.color = "#dc2626";
            statusEl.textContent = "Error de red";
        });
    };
    reader.readAsDataURL(file);
}

document.getElementById("volver").onclick = () => {
    document.getElementById("detalle").style.display = "none";
    document.getElementById("mainView").style.display = "block";
};



document.addEventListener("click", function(e) {
    if (e.target && e.target.id === "aliasCopy") {

        const alias = window.aliasActual; // üëà ahora s√≠ copia el alias real

        navigator.clipboard.writeText(alias).then(() => {

            e.target.textContent = "Alias copiado ‚úì";
            e.target.style.background = "linear-gradient(135deg, #16a34a, #22c55e)";
            e.target.style.transform = "scale(1.05)";
            e.target.style.animation = "none";

            setTimeout(() => {
                e.target.textContent = "Copiar alias";
                e.target.style.background = "";
                e.target.style.animation = "aliasPulse 2s infinite alternate";
            }, 1500);
        });
    }
});


</script>
</body>
</html>
